# Sentrix - Docker Start Script (Windows PowerShell)
# Inicio r√°pido de todos los servicios con Docker

Write-Host "üê≥ Sentrix - Docker Startup Script" -ForegroundColor Cyan
Write-Host "=================================" -ForegroundColor Cyan
Write-Host ""

# Check if Docker is running
Write-Host "üìã Verificando Docker..." -ForegroundColor Yellow
$dockerRunning = docker info 2>&1 | Out-Null
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå ERROR: Docker no est√° corriendo" -ForegroundColor Red
    Write-Host "   Por favor inicia Docker Desktop y vuelve a intentar" -ForegroundColor Red
    exit 1
}
Write-Host "‚úÖ Docker est√° corriendo" -ForegroundColor Green
Write-Host ""

# Check if .env exists
Write-Host "üìã Verificando configuraci√≥n..." -ForegroundColor Yellow
if (-not (Test-Path ".env")) {
    Write-Host "‚ö†Ô∏è  Archivo .env no encontrado" -ForegroundColor Yellow
    Write-Host "   Copiando .env.docker a .env..." -ForegroundColor Yellow
    Copy-Item ".env.docker" ".env"
    Write-Host "‚úÖ Archivo .env creado" -ForegroundColor Green
} else {
    Write-Host "‚úÖ Archivo .env encontrado" -ForegroundColor Green
}
Write-Host ""

# Ask user what to do
Write-Host "üöÄ ¬øQu√© deseas hacer?" -ForegroundColor Cyan
Write-Host "1. Iniciar TODO (primera vez o despu√©s de cambios)" -ForegroundColor White
Write-Host "2. Iniciar servicios (uso normal)" -ForegroundColor White
Write-Host "3. Parar TODO" -ForegroundColor White
Write-Host "4. Ver logs" -ForegroundColor White
Write-Host "5. Resetear TODO (¬°ELIMINA LA BASE DE DATOS!)" -ForegroundColor Red
Write-Host ""

$choice = Read-Host "Selecciona una opci√≥n (1-5)"

switch ($choice) {
    "1" {
        Write-Host ""
        Write-Host "üî® Building y starting todos los servicios..." -ForegroundColor Yellow
        docker-compose down
        docker-compose build --no-cache
        docker-compose up -d

        Write-Host ""
        Write-Host "‚è≥ Esperando que la base de datos est√© lista..." -ForegroundColor Yellow
        Start-Sleep -Seconds 10

        Write-Host ""
        Write-Host "üîÑ Ejecutando migraciones..." -ForegroundColor Yellow
        docker-compose exec -T backend alembic upgrade head

        Write-Host ""
        Write-Host "‚úÖ TODO LISTO!" -ForegroundColor Green
    }
    "2" {
        Write-Host ""
        Write-Host "üöÄ Iniciando servicios..." -ForegroundColor Yellow
        docker-compose up -d

        Write-Host ""
        Write-Host "‚úÖ Servicios iniciados!" -ForegroundColor Green
    }
    "3" {
        Write-Host ""
        Write-Host "üõë Parando servicios..." -ForegroundColor Yellow
        docker-compose down

        Write-Host ""
        Write-Host "‚úÖ Servicios detenidos!" -ForegroundColor Green
    }
    "4" {
        Write-Host ""
        Write-Host "üìú Mostrando logs (Ctrl+C para salir)..." -ForegroundColor Yellow
        docker-compose logs -f
    }
    "5" {
        Write-Host ""
        Write-Host "‚ö†Ô∏è  ADVERTENCIA: Esto eliminar√° TODA la base de datos" -ForegroundColor Red
        $confirm = Read-Host "¬øEst√°s seguro? (escribe 'SI' para confirmar)"

        if ($confirm -eq "SI") {
            Write-Host ""
            Write-Host "üóëÔ∏è  Eliminando todo..." -ForegroundColor Red
            docker-compose down -v
            docker system prune -f

            Write-Host ""
            Write-Host "‚úÖ Todo eliminado. Usa opci√≥n 1 para reiniciar" -ForegroundColor Green
        } else {
            Write-Host ""
            Write-Host "‚ùå Cancelado" -ForegroundColor Yellow
        }
    }
    default {
        Write-Host ""
        Write-Host "‚ùå Opci√≥n inv√°lida" -ForegroundColor Red
        exit 1
    }
}

Write-Host ""
Write-Host "üìä Estado de los servicios:" -ForegroundColor Cyan
docker-compose ps

Write-Host ""
Write-Host "üåê URLs de los servicios:" -ForegroundColor Cyan
Write-Host "   Backend API:    http://localhost:8000" -ForegroundColor White
Write-Host "   API Docs:       http://localhost:8000/docs" -ForegroundColor White
Write-Host "   YOLO Service:   http://localhost:8001" -ForegroundColor White
Write-Host "   Frontend:       http://localhost:3000" -ForegroundColor White
Write-Host "   PostgreSQL:     localhost:5432" -ForegroundColor White
Write-Host "   Redis:          localhost:6379" -ForegroundColor White

Write-Host ""
Write-Host "üí° Comandos √∫tiles:" -ForegroundColor Cyan
Write-Host "   Ver logs:       docker-compose logs -f" -ForegroundColor White
Write-Host "   Ver estado:     docker-compose ps" -ForegroundColor White
Write-Host "   Parar todo:     docker-compose down" -ForegroundColor White
Write-Host "   Reiniciar:      docker-compose restart" -ForegroundColor White

Write-Host ""
Write-Host "üéâ ¬°Listo para desarrollar!" -ForegroundColor Green
